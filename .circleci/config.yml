version: 2

jobs:
  plan-apply:
    working_directory: /tmp/project
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
    steps:
      - checkout
      - run:
          name: terraform init & plan
          command: |
            cd examples/eks-cluster-with-new-vpc
            terraform init -input=false
            terraform plan -target="module.vpc" -out tfapply-vpc
      - persist_to_workspace:
          root: .
          paths:
            - .
  apply-vpc:
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
    steps:
      - attach_workspace:
          at: .
      - run:
          name: terraform-apply-vpc
          command: |
            cd examples/eks-cluster-with-new-vpc
            terraform apply -target="module.vpc"  -auto-approve tfapply-vpc
      - persist_to_workspace:
          root: .
          paths:
            - .

  apply-eks:
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
    steps:
      - attach_workspace:
          at: .
      - run:
          name: terraform-apply-eks
          command: |
            cd examples/eks-cluster-with-new-vpc
            terraform plan -target="module.eks_blueprints" -out tfapply-eks
            terraform apply -target="module.eks_blueprints"   -auto-approve tfapply-eks
      - persist_to_workspace:
          root: .
          paths:
            - .

  apply-addons:
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
    steps:
      - attach_workspace:
          at: .
      - run:
          name: terraform-apply-addons
          command: |
            cd examples/eks-cluster-with-new-vpc
            terraform plan -target="module.eks_blueprints_kubernetes_addons" -out tfapply-addons
            terraform apply -target="module.eks_blueprints_kubernetes_addons"  -auto-approve tfapply-addons
      - persist_to_workspace:
          root: .
          paths:
            - .

  plan-destroy:
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
    steps:
      - attach_workspace:
          at: .
      - run:
          name: terraform create destroy plan
          command: |
            cd examples/eks-cluster-with-new-vpc
            terraform plan -destroy -out tfdestroy-vpc
      - persist_to_workspace:
          root: .
          paths:
            - .

  destroy-vpc:
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
    steps:
      - attach_workspace:
          at: .
      - run:
          name: terraform destroy
          command: |
            cd examples/eks-cluster-with-new-vpc
            terraform apply -target="module.vpc"  -auto-approve tfdestroy-vpc
            
  destroy-eks:
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
    steps:
      - attach_workspace:
          at: .
      - run:
          name: terraform destroy
          command: |
            cd examples/eks-cluster-with-new-vpc
            terraform plan -destroy -out tfdestroy-eks
            terraform apply -target="module.eks_blueprints"   -auto-approve tfdestroy-eks

  destroy-addons:
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
    steps:
      - attach_workspace:
          at: .
      - run:
          name: terraform destroy
          command: |
            cd examples/eks-cluster-with-new-vpc
            terraform plan -destroy -out tfdestroy-addons
            terraform apply -target="module.eks_blueprints_kubernetes_addons"  -auto-approve tfdestroy-addons

workflows:
  version: 2
  plan_approve_apply:
    jobs:
      - plan-apply
      - hold-apply:
          type: approval
          requires:
            - plan-apply
      - apply-vpc:
          requires:
            - hold-apply
      - apply-eks:
          requires:
            - apply-vpc
      # - apply-addons:
      #     requires:
      #       - apply-eks
      - plan-destroy:
          requires:
            - apply-eks
      - hold-destroy:
          type: approval
          requires:
            - plan-destroy
      - destroy-addons:
          requires:
            - hold-destroy
      - destroy-eks:
          requires:
            - destroy-addons
      - destroy-vpc:
          requires:
            - destroy-eks

